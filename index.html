<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Conectando con WhatsApp…</title>

  <!-- Meta Pixel -->
  <script>
    !function(f,b,e,v,n,t,s){
      if(f.fbq) return;
      n=f.fbq=function(){n.callMethod?
      n.callMethod.apply(n,arguments):n.queue.push(arguments)};
      if(!f._fbq) f._fbq=n;
      n.push=n; n.loaded=!0; n.version='2.0'; n.queue=[];
      t=b.createElement(e); t.async=!0;
      t.src=v; s=b.getElementsByTagName(e)[0];
      s.parentNode.insertBefore(t,s)
    }(
      window, document,'script',
      'https://connect.facebook.net/en_US/fbevents.js'
    );
    fbq('init', '1391288831895635');
    fbq('track', 'ViewContent');
  </script>
</head>
<body>
  <h1>Redirigiendo a WhatsApp…</h1>

  <script>
  document.addEventListener('DOMContentLoaded', async () => {
    // 1) Datos iniciales
    const whatsappNumber = '5491124782877';
    const mensajeBase     = 'Hola, vengo por el bono de bienvenida del 200%, ¿me creas un usuario?';

    // 2) Captura fbclid (query string / hash / referrer)
    const params = new URLSearchParams(window.location.search);
    let fbclid = params.get('fbclid') || '';
    if (!fbclid && window.location.hash.includes('fbclid=')) {
      const hp = new URLSearchParams(window.location.hash.slice(1));
      fbclid = hp.get('fbclid') || '';
    }
    if (!fbclid && document.referrer.includes('fbclid=')) {
      const refQs = document.referrer.split('?')[1] || '';
      const rp = new URLSearchParams(refQs);
      fbclid = rp.get('fbclid') || '';
    }
    if (!fbclid) fbclid = 'no_disponible';

    // 3) Generar ID único
    const bytes = new Uint8Array(16);
    crypto.getRandomValues(bytes);
    const id = Array.from(bytes)
      .map(b => b.toString(16).padStart(2,'0'))
      .join('');

    // 4) Timestamp
    const timestamp = new Date().toISOString();

    // 5) Enviar datos a Lambda (API Gateway)
    const payload = { id, fbclid, timestamp };
    try {
      await fetch('https://auo1x1y1li.execute-api.us-east-2.amazonaws.com/prod/visita', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
    } catch (err) {
      console.error('Error al enviar datos a Lambda:', err);
    }

    // 6) Redirigir a WhatsApp
    const texto = `${mensajeBase} Mi código es: ${id}`;
    const waUrl = `https://wa.me/${whatsappNumber}?text=${encodeURIComponent(texto)}`;
    window.location.href = waUrl;
  });
  </script>
</body>
</html>
