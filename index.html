<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Conectando con WhatsApp…</title>

  <!-- Meta Pixel -->
  <script>
    !function(f,b,e,v,n,t,s){
      if(f.fbq) return;
      n=f.fbq=function(){n.callMethod?
      n.callMethod.apply(n,arguments):n.queue.push(arguments)};
      if(!f._fbq) f._fbq=n;
      n.push=n; n.loaded=!0; n.version='2.0'; n.queue=[];
      t=b.createElement(e); t.async=!0;
      t.src=v; s=b.getElementsByTagName(e)[0];
      s.parentNode.insertBefore(t,s)
    }(
      window, document,'script',
      'https://connect.facebook.net/en_US/fbevents.js'
    );
    fbq('init', '1391288831895635');
    fbq('track', 'ViewContent');
  </script>
</head>
<body>
  <h1>Redirigiendo a WhatsApp…</h1>

  <script>
  document.addEventListener('DOMContentLoaded', async () => {
    // 1) Datos iniciales
    const whatsappNumber = '5491124782877';
    const mensajeBase     = 'Hola, vengo por el bono de bienvenida del 200%, ¿me creas un usuario?';

    // 2) Captura fbclid
    const params = new URLSearchParams(window.location.search);
    let fbclid = params.get('fbclid') || '';
    if (!fbclid && window.location.hash.includes('fbclid=')) {
      const hp = new URLSearchParams(window.location.hash.slice(1));
      fbclid = hp.get('fbclid') || '';
    }
    if (!fbclid && document.referrer.includes('fbclid=')) {
      const refQs = document.referrer.split('?')[1] || '';
      const rp = new URLSearchParams(refQs);
      fbclid = rp.get('fbclid') || '';
    }
    if (!fbclid) fbclid = 'no_disponible';

    // 3) Obtener IP, ubicación y dominio vía Geo IPify
    let ip = '', country = '', region = '', city = '', domain = '';
    try {
      const resp = await fetch(
        'https://geo.ipify.org/api/v2/country,city,asn?apiKey=at_bm13j7tXoeE9XJOVK83yQAJO6JPrg'
      );
      const j = await resp.json();
      ip      = j.ip      || '';
      country = j.location?.country || '';
      region  = j.location?.region  || '';
      city    = j.location?.city    || '';
      domain  = j.asn?.domain       || '';
    } catch (err) {
      console.warn('Error al obtener GeoIP:', err);
    }

    // 4) Generar ID único (16 bytes → 32 hex chars)
    const bytes = new Uint8Array(16);
    crypto.getRandomValues(bytes);
    const id = Array.from(bytes)
      .map(b => b.toString(16).padStart(2,'0'))
      .join('');

    // 5) Timestamp ISO
    const timestamp = new Date().toISOString();

    // 6) Enviar datos a API Gateway → Lambda → RDS
    try {
      await fetch(
        'https://auo1x1y1li.execute-api.us-east-2.amazonaws.com/prod/visita',
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            id,
            fbclid,
            ip,
            country,
            region,
            city,
            domain,
            timestamp
          })
        }
      );
    } catch (err) {
      console.error('Error al enviar datos al servidor:', err);
    }

    // 7) Construir URL de WhatsApp y redirigir
    const texto = `${mensajeBase} Mi código es: ${id}`;
    const waUrl = `https://wa.me/${whatsappNumber}?text=${encodeURIComponent(texto)}`;

    if (document.readyState === 'complete') {
      window.location.href = waUrl;
    } else {
      window.addEventListener('load', () => {
        window.location.href = waUrl;
      });
    }
  });
  </script>
</body>
</html>
